<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Reef Rangers</title>
    <link rel="stylesheet" href="../css/styles.css" />
  </head>
  <body class="home">
    <!-- Sign out X -->
    <a id="close" href="index.html" onclick="signOut()">✕</a>
    <div id="app">
      <!-- Top currency -->
      <div id="currency-container">
        <div class="apple-glass currency">
          <span class="emoji" id="streak">🔱 0 Day Streak</span>
        </div>
        <div class="apple-glass currency">
          <span class="emoji" id="seashells">🐚 0 Seashells</span>
        </div>
      </div>

      <!-- Creature -->
      <div id="creature-info"></div>
      <div id="creature-container">
        <img src="../images/shellfin.png" alt="Creature Sprite" />
      </div>

      <!-- Bottom nav -->
        <div class="apple-glass" id="nav">
          <a class="nav-item" href="#" id="mission-link">
            <span class="emoji">🤿</span>
            <span class="text">Mission</span>
          </a>
        <div class="nav-item">
          <span class="emoji">🐠</span>
          <span class="text">Creatures</span>
        </div>
        <div class="nav-item">
          <span class="emoji">🪸</span>
          <span class="text">Market</span>
        </div>
      </div>
    </div>

    <script src="../js/userData.js"></script>
    <script>
      const user = getCurrentUser();
      if (user) {
        const now = Date.now();
        const oneDay = 24 * 60 * 60 * 1000;
        let { signInStreak, lastSignIn } = user;
        if (!lastSignIn || now - lastSignIn >= oneDay) {
          signInStreak += 1;
          lastSignIn = now;
          updateCurrentUser({ signInStreak, lastSignIn });
        }
        document.getElementById("streak").textContent =
          `🔱 ${signInStreak} Day Streak`;
        document.getElementById("seashells").textContent =
          `🐚 ${user.seashells} Seashells`;
        if (user.creatures && user.creatures.length > 0) {
          const c = user.creatures[0];
          const infoEl = document.getElementById("creature-info");
          if (infoEl) infoEl.textContent = c.name;
          const imgEl = document.querySelector("#creature-container img");
          if (imgEl && c.sprite && c.sprite.normal)
            imgEl.src = c.sprite.normal;
        }

        const missionLink = document.getElementById("mission-link");
        if (missionLink) {
          missionLink.addEventListener("click", async (e) => {
            e.preventDefault();
            try {
              const res = await fetch("../data/missions.json");
              const data = await res.json();
              if (Array.isArray(data.missions) && data.missions.length > 0) {
                let missionIndex = 0;
                if (Array.isArray(user.missionsCompleted)) {
                  const idx = user.missionsCompleted.findIndex(
                    (m) => !m.completed,
                  );
                  if (idx !== -1) missionIndex = idx;
                }
                const mission = data.missions[missionIndex];
                sessionStorage.setItem(
                  "currentMission",
                  JSON.stringify(mission),
                );
                sessionStorage.setItem(
                  "currentMissionIndex",
                  String(missionIndex),
                );
                window.location.href = "battle.html";
              }
            } catch (err) {
              console.error("Failed to load missions:", err);
            }
          });
        }
      } else {
        window.location.href = "index.html";
      }
    </script>
    <script src="../js/bubbles.js"></script>
  </body>
</html>
